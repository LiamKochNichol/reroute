<<!DOCTYPE html>
<html>
  <head>
    <title>King Street</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript">

      $(document).ready(() => {

        $('#getProfile').click(() => {
          const requestURL = 'king/' + $('#nameBox').val();
          console.log('Making request to: ', requestURL);
          $.ajax({
            url: requestURL,
            type: 'GET',
            dataType: 'json',
            success: (data) => {
              if (data.name && data.room && data.floor && data.route) {
                $('#name').html('Resident Name: ' + data.name);
                $('#room').html('Room is ye: ' + data.room);
                $('#floor').html('Floor is: ' + data.floor);
                $('#route').html('Route is: ' + data.route);
              } else {
                $('#name').html('Name and/or.');
                $('#room').html('Room is unknown.');
              }
            }
          });
        });

        $('#refreshTable').click(() => {
          $.ajax({
            url: 'king/residents',
            type: 'GET',
            dataType: 'text',
            success: (data) => {
              data = JSON.parse(data);
              let html = '';
              html += '<tr>';
              let flag = 0;
              $.each(data[0], (index, value) => {
                html += '<th>'+index.toUpperCase() +'</th>';
              });
              html += '</tr>';
              $.each(data, (index, value) => {
                html += '<tr>';
                $.each(value, (index2, value2) => {
                  if (index2 === 'name') {
                    html += '<td><button id = ' + value2.replace(/\s/g, '') + ' onClick="clickRespond(this.id)">' + value2 + '</button></td>';
                  } else {
                    html += '<td>'+value2+'</td>';
                  }
                });
                html += '<tr>';
              });
              $('#table').html(html);
            }
          });
        });

        $('#insertButton').click(() => {
          $.ajax({
            url: 'king',
            type: 'POST',
            data: {
              name: $('#insertName').val(),
              room: $('#insertRoom').val(),
            },
            success: (data) => {
              $('#status').html(data.message);
            }
          });
        });

        $('#deleteButton').click(() => {
          let ele = document.getElementById('deleteButton');
          let resName = ele.className;
          resName = resName.split('_').join(' ')
          console.log(resName);
          $.ajax({
            url: 'king/delete',
            type: 'POST',
            data: jQuery.param({
                name: resName
              }),
            success: (response) => {
              console.log('Delete request success');
            }
          });
        });

        document.getElementById("refreshTable").click();


        let coll = document.getElementsByClassName("collapsible");
        let i;

        for (i = 0; i < coll.length; i++) {
          coll[i].addEventListener("click", function() {
            this.classList.toggle("active");
            let content = this.nextElementSibling;
            if (content.style.display === "none") {
              content.style.display = "block";
            } else {
              content.style.display = "none";
            }
          });
        }
        for (i = 0; i < coll.length; i++) {
          coll[i].click();
        }

        clickRespond = (clicked_id) => {
          const resName = document.getElementById(clicked_id).innerText;
          const requestURL = 'king/' + resName;
          console.log('Making request to: ', requestURL);
          $.ajax({
            url: requestURL,
            type: 'GET',
            dataType: 'json',
            success: (data) => {
              if (data.name && data.room && data.floor && data.route) {
                $('#name').html('Resident Name: ' + data.name);
                $('#room').html('Room is: ' + data.room);
                $('#floor').html('Floor is: ' + data.floor);
                $('#deleteButton').html('Remove Resident From Database');
                let element = document.getElementById('deleteButton');
                let cname = element.className;
                document.getElementById('deleteButton').classList.add(resName.split(' ').join('_'));
                document.getElementById('deleteButton').classList.remove(cname);
              } else {
                $('#name').html('Name and/or');
                $('#room').html('room is unknown.');
              }
            }
          });
        }
      });

    </script>

    <style>

    table,
    td {
      border: 1px solid #333;
    }

    </style>

  </head>
  <body>

    <h1>King Street</h1>

    <button id="find" class="collapsible">Find A Resident</button>
    <div class="content">
      Name: <input id="nameBox" type="text" size="20"/>
      <button id="getProfile">Get Profile<button>
    </div>

    <button id="add" class="collapsible">Add A Resident</button>
    <div class="content">
      Name: <input id="insertName" type="text" size="20"/>
      Room: <input id="insertRoom" type="text" size="20"/>
      <button id="insertButton">Insert Into Database</button>
    </div>

    <div>
      <p id="name"></p>
      <p id="room"></p>
      <p id="floor"></p>
      <p id="route"></p>
      <button id="deleteButton" class="empty"></button>
    </div>

    <div class="container">
      <button id="refreshTable">Refresh Table</button>
      <h3>Residents On King St.<h3>
      <table id="table" class="table table-striped"></table>
    </div>

  </body>
</html>
