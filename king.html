<<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <title>King Street</title>

    <script type="text/javascript">

      $(document).ready(() => {

        $('#getProfile').click(() => {
          let resName = $('#nameBox').val()
          residentInfo(resName);
        });

        $('#refreshTable').click(() => {
          $.ajax({
            url: 'king/residents',
            type: 'GET',
            dataType: 'text',
            success: (data) => {
              data = JSON.parse(data);
              let html = '';
              html += '<tr>';
              let flag = 0;
              $.each(data[0], (index, value) => {
                html += '<th>'+index.toUpperCase() +'</th>';
              })
              html += '</tr>';
              $.each(data, (index, value) => {
                html += '<tr>';
                $.each(value, (index2, value2) => {
                  if (value2 === null) {
                    html += '<td>NULL</td>';
                  } else if (index2 === 'name') {
                    let i = 0;
                    let cnt = 0;
                    for (i = 0; i < value2.length; i++) {
                      if (value2[i] === ' ') {
                        cnt = 1;
                      }
                    }
                    if (cnt === 1) {
                      html += '<td><button id = ' + value2.replace(/\s/g, '') + ' onClick="tableRespond(this.id)">' + value2 + '</button></td>';
                    } else {
                      html += '<td><button id = ' + value2 + ' onClick="tableRespond(this.id)">' + value2 + '</button></td>';
                    }
                  } else {
                    html += '<td>'+value2+'</td>';
                  }
                });
                html += '<tr>';
              });
              $('#table').html(html);
            }
          });
        });

        $('#insertButton').click(() => {
          $.ajax({
            url: 'king',
            type: 'POST',
            data: {
              name: $('#insertName').val(),
              room: $('#insertRoom').val(),
            },
            success: (data) => {
              console.log('Insert success');
            }
          });
        });

        $('#deleteButton').click(() => {
          let ele = document.getElementById('save');
          let resName = ele.className;
          resName = resName.split('_').join(' ');
          $.ajax({
            url: 'king/delete',
            type: 'POST',
            data: jQuery.param({
                name: resName
              }),
            success: (response) => {
              console.log('Delete request success');
            }
          });
        });

        $('#editButton').click(() => {
          let ele = document.getElementById('saveName');
          let resName = ele.className;
          resName = resName.split('_').join(' ');
          requestURL = 'king/' + resName;
          $.ajax({
            url: requestURL,
            type: 'GET',
            dataType: 'json',
            success: (data) => {
              if (data.name && data.room && data.floor && data.route) {
                //hide the shown data first
                $('#residentInformation').hide();
                //create name variable
                let newName = ((data.name).toString()).split(' ').join('_');
                //create form to enter, change and show the data
                $('#editInformation').html(
                '<form>'
                + 'Name: <input type=\"text\" id=\"editName\" value=\"' + newName.split('_').join(' ') + '\" />'
                + 'Room Number: <input type=\"integer\" id=\"editRoom\" value=\"' + data.room + '\" />'
                + '<button onclick=\"editFunction()\">Submit</button>'
                + '</form>'
                );
              } else {
                console.log("Edit error");
              }
            }
          });
        });

        document.getElementById("refreshTable").click();
        $('#residentOptions').hide();

        let coll = document.getElementsByClassName("collapsible");
        let i;

        for (i = 0; i < coll.length; i++) {
          coll[i].addEventListener("click", function() {
            this.classList.toggle("active");
            let content = this.nextElementSibling;
            if (content.style.display === "none") {
              content.style.display = "block";
            } else {
              content.style.display = "none";
            }
          });
        }
        for (i = 0; i < coll.length; i++) {
          coll[i].click();
        }

      });

      tableRespond = (clicked_id) => {
        const resName = document.getElementById(clicked_id).innerText;
        residentInfo(resName);
      };

      residentInfo = (resName) => {
        const requestURL = 'king/' + resName;
        $.ajax({
          url: requestURL,
          type: 'GET',
          dataType: 'json',
          success: (data) => {
            if (data.name && data.room && data.floor && data.route) {
              //write info on page
              $('#name').html('Resident Name: ' + data.name);
              $('#room').html('Room is: ' + data.room);
              $('#floor').html('Floor is: ' + data.floor);
              $('#deleteButton').html('Remove Resident From Database');
              $('#editButton').html('Edit Resident Information');
              //show resident options to edit or delete
              $('#residentOptions').show();
              //update the saved name and room
              updateSaved(resName, data.room);
            } else {
              $('#name').html('Name and/or');
              $('#room').html('room is unknown.');
            }
          }
        });
      }

      editFunction = () => {
        const requestURL = 'king/edit/name';
        const newName = (document.getElementById('editName')).value;
        const newRoom = (document.getElementById('editRoom')).value;
        const thisName = (document.getElementById('saveName')).className;
        const oldRoom = (document.getElementById('saveRoom')).className;
        let oldName;
        let i = 0;
        let cnt = 0;
        for (i = 0; i < thisName.length; i++) {
          if (thisName[i] === '_') {
            cnt = 1;
          }
        }
        if (cnt = 1) {
          oldName = thisName.split('_').join(' ');
        } else {
          oldName = thisName;
        }
        $.ajax({
          url: requestURL,
          type: 'POST',
          data: jQuery.param({
              newName: newName,
              newRoom: newRoom,
              //need old info to identify resident
              oldName: oldName,
              oldRoom: oldRoom
            }),
          success: (response) => {
            updateSaved(newName, newRoom);
            document.getElementById("refreshTable").click();
            $('#editInformation').hide();
            $('#residentInformation').show();
          }
        });
/*
        document.getElementById("refreshTable").click();
        $('#editInformation').hide();
        $('#residentInformation').show();*/
      }

      updateSaved = (resName, resRoom) => {
        //update the saved name for other uses on the page
        let namesave = document.getElementById('saveName');
        let savedName = namesave.className;
        if (savedName !== resName) {
          document.getElementById('saveName').classList.add(resName.split(' ').join('_'));
          document.getElementById('saveName').classList.remove(savedName);
        } else {
          console.log("Multiple clicks or same name.");
        }
        //update the saved room for other uses on the page
        let room = document.getElementById('saveRoom');
        let savedRoom = room.className;
        if (savedRoom !== resRoom) {
          document.getElementById('saveRoom').classList.add(resRoom);
          document.getElementById('saveRoom').classList.remove(savedRoom);
        } else {
          console.log("Multiple clicks or same room.");
        }
      }
    </script>
  </head>
  <body>

    <h1 class="text-center">King Street</h1>

    <!--div to save the name of the resident-->
    <div id="saveName" class="empty"></div>
    <div id="saveRoom" class="empty"></div>

    <input id="nameBox" type="text" size="20" value="Search for Resident"/>
    <button id="getProfile">Search</button>
    <br>
    <br>
    <button id="add" class="collapsible">Add A Resident</button>
    <div class="content">
      Name: <input id="insertName" type="text" size="20"/>
      Room: <input id="insertRoom" type="text" size="20"/>
      <button id="insertButton">Insert Into Database</button>
    </div>

    <div id="residentInformation">
      <p id="name"></p>
      <p id="room"></p>
      <p id="floor"></p>
      <p id="route"></p>
      <div id="residentOptions">
        <button id="editButton"></button>
        <button id="deleteButton"></button>
      </div>
    </div>

    <div id="editInformation"></div>

    <div>
      <button id="refreshTable">Refresh Table</button>
      <h3>Residents On King St.<h3>
      <table id="table"></table>
    </div>


  </body>
</html>
